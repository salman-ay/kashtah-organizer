<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÙƒØ´ØªØ© | Ø¬Ù‡Ù‘Ø² ÙƒØ´ØªØªÙƒ</title>
    <style>
        :root {
            --primary: #2D6A4F;
            --accent: #D8F3DC;
            --text: #1B4332;
            --bg: #F8F9FA;
            --white: #FFFFFF;
            --danger: #e63946;
            --gray: #ced4da;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- UI COMPONENTS --- */
        header {
            background-color: var(--white);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--primary); cursor: pointer; }
        .back-btn { font-size: 1.5rem; cursor: pointer; border: none; background: none; padding: 0;}

        .screen {
            display: none; flex: 1; padding: 20px; flex-direction: column;
            animation: fadeIn 0.3s ease; overflow-y: auto;
        }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-main {
            background-color: var(--primary); color: white; border: none; padding: 16px;
            border-radius: 12px; font-size: 1.1rem; font-weight: bold; width: 100%;
            cursor: pointer; margin-top: 20px; box-shadow: 0 4px 12px rgba(45, 106, 79, 0.2);
        }

        .action-bar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn-secondary {
            background-color: white; color: var(--primary); border: 1px solid var(--primary);
            padding: 10px; border-radius: 8px; font-weight: bold; flex: 1; cursor: pointer;
            font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-secondary.active-edit { background-color: var(--primary); color: white; }

        .card {
            background: white; padding: 20px; border-radius: 16px; margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #eee; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 15px;
        }
        .card:active { transform: scale(0.98); }
        .card h3 { font-size: 1.1rem; margin: 0 0 5px 0; }
        .card p { color: #666; font-size: 0.85rem; margin: 0; }
        .emoji-icon { font-size: 2rem; }

        .saved-item {
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .saved-info h4 { margin: 0 0 5px 0; }
        .saved-info span { font-size: 0.8rem; color: #888; }
        .delete-saved-btn { color: var(--danger); background: none; border: none; font-size: 1.2rem; padding: 10px; cursor: pointer;}

        /* LIST STYLES */
        .list-section { margin-bottom: 25px; }
        .section-title { 
            font-size: 0.95rem; color: var(--primary); margin-bottom: 10px; font-weight: bold;
            background: #eef5f2; padding: 5px 10px; border-radius: 8px; display: inline-block;
        }
        
        .list-item {
            background: white; padding: 10px 15px; border-bottom: 1px solid #f0f0f0;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px;
        }
        .list-item:first-child { border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .list-item:last-child { border-bottom: none; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }

        .item-content { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 150px; }
        .item-icon { font-size: 1.4rem; cursor: default; }
        .item-icon.editable { cursor: pointer; background: #eee; border-radius: 50%; width: 35px; height: 35px; text-align: center; line-height: 35px; }
        .item-text { font-size: 0.95rem; }
        .item-input-edit {
            border: 1px solid var(--primary); padding: 5px; border-radius: 5px; font-size: 0.9rem; width: 100%;
        }

        .assignee-input {
            border: 1px solid var(--gray); background: #fdfdfd; border-radius: 6px;
            padding: 6px 10px; font-size: 0.8rem; width: 90px; color: #555; transition: 0.2s;
        }
        .assignee-input:focus { border-color: var(--primary); outline: none; background: white; width: 110px; }

        .delete-btn { color: var(--danger); cursor: pointer; font-weight: bold; padding: 5px; font-size: 1.1rem; }
        
        .add-row { display: flex; padding: 10px; background: #f9f9f9; border-top: 1px solid #eee; gap: 10px; }
        .add-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .add-btn-small { background: var(--primary); color: white; border: none; border-radius: 6px; width: 35px; cursor: pointer; }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-box {
            background: white; padding: 20px; border-radius: 16px; width: 90%; max-width: 350px;
            text-align: center; max-height: 80vh; overflow-y: auto;
        }
        .modal-title { font-weight: bold; margin-bottom: 15px; display: block; }
        .icon-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .icon-option { font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 8px; }
        .icon-option:hover { background: #eee; }
        
        .copy-option-btn {
            display: block; width: 100%; padding: 15px; margin-bottom: 10px;
            border: 1px solid #ddd; border-radius: 12px; background: #fff; font-size: 1rem; cursor: pointer;
        }
        .copy-option-btn:hover { background: #f9f9f9; border-color: var(--primary); }

        input[type="number"] { width: 100%; padding: 15px; font-size: 1.5rem; text-align: center; border: 2px solid #ddd; border-radius: 12px; margin: 20px 0; box-sizing: border-box; }
        .hidden { display: none !important; }
        .empty-state { text-align: center; padding: 30px; color: #aaa; background: #f0f0f0; border-radius: 12px; margin-top: 10px; }
    </style>
</head>
<body>

    <header id="app-header">
        <button class="back-btn hidden" onclick="goBack()">â†</button>
        <div class="logo" onclick="goToHome()">ÙƒØ´ØªØ© â›º</div>
        <div style="width: 24px;"></div>
    </header>

    <div id="home-screen" class="screen active">
        <div style="text-align: center; margin-top: 30px; margin-bottom: 30px;">
            <span style="font-size: 3.5rem;">ğŸ•ï¸</span>
            <h1>Ø¬Ù‡Ù‘Ø² ÙƒØ´ØªØªÙƒ</h1>
            <p style="color: #666;">Ø±ØªÙ‘Ø¨ Ø£ØºØ±Ø§Ø¶Ùƒ ÙˆÙ„Ø§ ØªÙ†Ø³Ù‰ Ø´ÙŠ</p>
        </div>
        <button class="btn-main" onclick="nextScreen('type-screen')" style="margin-top:0; margin-bottom: 30px;">â• Ø¬Ù‡Ù‘Ø² ÙƒØ´ØªØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <h3 style="margin-bottom: 10px;">ÙƒØ´Ø§ØªÙƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ğŸ“‚</h3>
        <div id="saved-list-container"></div>
    </div>

    <div id="type-screen" class="screen">
        <h2>ÙˆØ´ Ù†ÙˆØ¹ Ø§Ù„ÙƒØ´ØªØ©ØŸ</h2>
        <div style="margin-top: 20px;">
            <div class="card" onclick="selectType('land')">
                <span class="emoji-icon">ğŸŒµ</span><div><h3>ÙƒØ´ØªØ© Ø¨Ø±</h3><p>Ø®Ù„Ø§Ø¡ØŒ Ø±Ù…Ù„ØŒ ÙˆØ¬Ù„Ø³Ø© Ø£Ø±Ø¶ÙŠØ©</p></div>
            </div>
            <div class="card" onclick="selectType('sea')">
                <span class="emoji-icon">ğŸ–ï¸</span><div><h3>ÙƒØ´ØªØ© Ø¨Ø­Ø±</h3><p>Ø´Ø§Ø·Ø¦ØŒ Ø±Ø·ÙˆØ¨Ø©ØŒ ÙˆØ¬Ù„Ø³Ø© ÙƒØ±Ø§Ø³ÙŠ</p></div>
            </div>
            <div class="card" onclick="selectType('chalet')">
                <span class="emoji-icon">ğŸ¡</span><div><h3>Ø´Ø§Ù„ÙŠÙ‡ / Ø§Ø³ØªØ±Ø§Ø­Ø©</h3><p>Ù…ÙƒØ§Ù† Ù…Ø¬Ù‡Ø²ØŒ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ù…ØªÙˆÙØ±Ø©</p></div>
            </div>
        </div>
    </div>

    <div id="style-screen" class="screen">
        <h2>Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙƒÙ„ ÙˆØ§Ù„Ø´Ø±Ø¨ØŸ</h2>
        <div style="margin-top: 20px;">
            <div class="card" onclick="selectStyle('cooking')">
                <span class="emoji-icon">ğŸ³</span><div><h3>Ù…Ø¹ Ø·Ø¨Ø® ÙˆÙ†ÙØ®</h3><p>ØºØ¯Ø§Ø¡/Ø¹Ø´Ø§Ø¡ØŒ Ù‚Ø¯ÙˆØ±ØŒ ÙˆÙ…ÙƒÙˆÙ†Ø§Øª</p></div>
            </div>
            <div class="card" onclick="selectStyle('prep_drinks')">
                <span class="emoji-icon">ğŸ”¥</span><div><h3>Ø¨Ø¯ÙˆÙ† Ø·Ø¨Ø® (ØªØ­Ø¶ÙŠØ± Ù‚Ù‡ÙˆØ©)</h3><p>Ø¨Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø¯Ù„Ø© ÙˆØ§Ù„Ù…Ø¹Ø§Ù…ÙŠÙ„ ÙˆÙ†Ø¶Ø¨Ø·Ù‡Ø§</p></div>
            </div>
            <div class="card" onclick="selectStyle('ready_drinks')">
                <span class="emoji-icon">â˜•</span><div><h3>Ø¨Ø¯ÙˆÙ† Ø·Ø¨Ø® (Ø¬Ø§Ù‡Ø²)</h3><p>Ù†Ø¬ÙŠØ¨ Ø§Ù„ØªØ±Ø§Ù…Ø³ Ø¬Ø§Ù‡Ø²Ø© Ù…Ø¹Ù†Ø§</p></div>
            </div>
        </div>
    </div>

    <div id="count-screen" class="screen">
        <h2>ÙƒÙ… Ø¹Ø¯Ø¯ÙƒÙ…ØŸ</h2>
        <p style="color: #666;">Ø¹Ø´Ø§Ù† Ù†Ø¶Ø¨Ø· Ù„Ùƒ Ø§Ù„ÙƒÙ…ÙŠØ§Øª (ØªÙ‚Ø±ÙŠØ¨ÙŠ)</p>
        <input type="number" id="people-count" value="4" min="1">
        <button class="btn-main" onclick="generateNewList()">Ø¬Ù‡Ù‘Ø² Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ğŸš€</button>
    </div>

    <div id="list-screen" class="screen">
        <div class="action-bar">
            <button class="btn-secondary" onclick="toggleEditMode()" id="edit-btn">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn-secondary" onclick="saveCurrentList()">ğŸ’¾ Ø­ÙØ¸</button>
            <button class="btn-secondary" onclick="showCopyModal()">ğŸ“¤ Ù†Ø³Ø®</button>
        </div>
        <div id="list-container" style="padding-bottom: 80px;"></div>
    </div>

    <div id="icon-modal" class="modal-overlay" onclick="closeIconModal(event)">
        <div class="modal-box">
            <span class="modal-title">Ø§Ø®ØªØ± Ø£ÙŠÙ‚ÙˆÙ†Ø©</span>
            <div class="icon-grid" id="icon-grid">
                </div>
        </div>
    </div>

    <div id="copy-modal" class="modal-overlay" onclick="closeCopyModal(event)">
        <div class="modal-box">
            <span class="modal-title">ÙƒÙŠÙ Ø­Ø§Ø¨ ØªÙ†Ø³Ø® Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŸ</span>
            <button class="copy-option-btn" onclick="copyToClipboard('category')">ğŸ“„ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„ØªØµÙ†ÙŠÙ)</button>
            <button class="copy-option-btn" onclick="copyToClipboard('person')">ğŸ‘¤ Ø­Ø³Ø¨ Ø§Ù„Ø£Ø´Ø®Ø§Øµ</button>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        let currentSettings = { type: '', style: '', count: 4 };
        let activeList = []; 
        let isEditing = false;
        let historyStack = ['home-screen'];
        
        let editingItemIndices = { sec: null, item: null };

        const ICONS_LIST = [
            "ğŸ–", "ğŸ—", "ğŸš", "ğŸ§…", "ğŸ§‚", "ğŸ«—", "ğŸ²", "ğŸªµ", "ğŸ”ª", "ğŸ¥£", "ğŸ¥¢", "ğŸ§Š", "ğŸ—‘ï¸",
            "â˜•", "ğŸ«–", "ğŸ¥›", "ğŸŒ¿", "ğŸ¬", "ğŸ§‚", "ğŸ”¥", "ğŸ§±", "ğŸ®", "ğŸ›‹ï¸", "ğŸ§´", "ğŸ©¹", "ğŸ”¦",
            "ğŸ§´", "ğŸ•¶ï¸", "â›±ï¸", "ğŸ–ï¸", "ğŸ£", "ğŸ¦", "ğŸŒ­", "ğŸ”", "ğŸ¥ª", "ğŸ¥¤", "â›º", "ğŸš™", "ğŸª‘"
        ];

        // --- TEMPLATES ---
        const TEMPLATES = {
            land: {
                cooking: [
                    { cat: "Ø§Ù„Ù…Ù‚Ø§Ø¶ÙŠ", items: [
                        {t: "Ù„Ø­Ù…/Ø¯Ø¬Ø§Ø¬ (250Ø¬ Ù„Ù„Ø´Ø®Øµ)", i: "ğŸ–"}, {t: "Ø±Ø² (Ù†Øµ ÙƒÙˆØ¨ Ù„Ù„Ø´Ø®Øµ)", i: "ğŸš"}, {t: "Ø¨ØµÙ„ ÙˆØ·Ù…Ø§Ø·Ù…", i: "ğŸ§…"}, {t: "Ø¨Ù‡Ø§Ø±Ø§Øª ÙˆÙ…Ù„Ø­", i: "ğŸ§‚"}, {t: "Ø²ÙŠØª", i: "ğŸ«—"}, {t: "Ù…Ø§Ø¡ Ø·Ø¨Ø®", i: "ğŸš°"}
                    ]},
                    { cat: "Ø¹Ø¯Ø© Ø§Ù„Ø·Ø¨Ø®", items: [
                        {t: "Ù‚Ø¯Ø± Ø·Ø¨Ø®", i: "ğŸ²"}, {t: "Ø¨Ø§Ø¯ÙŠØ© (ØºØ³ÙŠÙ„ Ø±Ø² ÙˆÙ†Ù‚Ø¹)", i: "ğŸ¥£"}, {t: "Ø°Ø±Ø§ÙŠØ© (Ù…ØµØ¯ Ù‡ÙˆØ§Ø¡)", i: "ğŸ§±"}, {t: "Ø¨ÙŠØ² (Ù…Ø³Ø§ÙƒØ©)", i: "ğŸ§¤"}, {t: "Ù…ØºØ±ÙØ© ÙˆÙ…Ù„Ø§Ø³", i: "ğŸ¥¢"}, {t: "Ø³ÙƒÙŠÙ† ÙˆÙ„ÙˆØ­ ØªÙ‚Ø·ÙŠØ¹", i: "ğŸ”ª"}, {t: "ØµØ­ÙˆÙ† ÙˆÙ…Ù„Ø§Ø¹Ù‚", i: "ğŸ½ï¸"}, {t: "Ø³ÙØ±Ø© Ø·Ø¹Ø§Ù…", i: "ğŸ“œ"}, {t: "Ø¯Ø§ÙÙˆØ± ÙƒØ¨ÙŠØ±/ØºØ§Ø²", i: "ğŸ”¥"}, {t: "Ø£ÙƒÙŠØ§Ø³ Ù†ÙØ§ÙŠØ§Øª", i: "ğŸ—‘ï¸"}
                    ]},
                    { cat: "Ø§Ù„Ù…Ø¹Ø§Ù…ÙŠÙ„", items: [
                        {t: "Ù‚Ù‡ÙˆØ© Ù…Ø·Ø­ÙˆÙ†Ø©", i: "â˜•"}, {t: "Ù‡ÙŠÙ„ Ù…Ø·Ø­ÙˆÙ†", i: "ğŸŒ¿"}, {t: "Ø²Ø¹ÙØ±Ø§Ù†", i: "ğŸŒ¸"}, {t: "Ø´Ø§ÙŠ", i: "ğŸ«–"}, {t: "Ø³ÙƒØ±", i: "ğŸ¬"}
                    ]},
                    { cat: "Ø¹Ø²Ø¨Ø© Ø§Ù„Ù‚Ù‡ÙˆØ©", items: [
                        {t: "Ù„Ù‚Ù…Ø© (Ù…ÙÙˆØ§Ø­)", i: "ğŸ”¥"}, {t: "Ø¯Ù„Ø© Ù‚Ù‡ÙˆØ©", i: "ğŸº"}, {t: "Ø¥Ø¨Ø±ÙŠÙ‚ Ø´Ø§Ù‡ÙŠ", i: "ğŸ«–"}, {t: "Ø¨ÙŠØ²", i: "ğŸ§¤"}, {t: "Ø²Ù…Ø²Ù…ÙŠØ© (ØªØ±Ù…Ø³)", i: "ğŸ§Š"}, {t: "ÙÙ†Ø§Ø¬ÙŠÙ„ ÙˆØ¨ÙŠØ§Ù„Ø§Øª", i: "ğŸ¥›"}, {t: "Ù…Ø§Ø¡ ØµØ­Ø©", i: "ğŸ’§"}
                    ]},
                    { cat: "Ø´Ø¨Ù‘Ø© Ø§Ù„Ø¶Ùˆ", items: [
                        {t: "Ù…Ù†Ù‚Ø¯", i: "ğŸ”¥"}, {t: "Ø­Ø·Ø¨/ÙØ­Ù…", i: "ğŸªµ"}, {t: "Ù…Ù„Ù‚Ø§Ø·", i: "ğŸ¥¢"}, {t: "ÙˆÙ„Ø§Ø¹Ø© ÙˆÙ…ÙƒØ¹Ø¨Ø§Øª", i: "ğŸ§¨"}
                    ]},
                    { cat: "Ø§Ù„Ø¬Ù„Ø³Ø©", items: [
                        {t: "ÙØ±Ø´Ø©", i: "ğŸ›‹ï¸"}, {t: "ÙƒØ±Ø§Ø³ÙŠ", i: "ğŸª‘"}, {t: "Ù…Ø³Ø§Ù†Ø¯/Ù…Ø±Ø§ÙƒÙ‰", i: "ğŸ›‹ï¸"}, {t: "Ù„Ù…Ø¨Ø© Ø³Ù†Ø§Ø±Ø©", i: "ğŸ’¡"}
                    ]}
                ],
                prep_drinks: [
                    { cat: "Ø§Ù„Ù…Ø¹Ø§Ù…ÙŠÙ„", items: [
                        {t: "Ù‚Ù‡ÙˆØ© Ù…Ø·Ø­ÙˆÙ†Ø©", i: "â˜•"}, {t: "Ù‡ÙŠÙ„", i: "ğŸŒ¿"}, {t: "Ø²Ø¹ÙØ±Ø§Ù†", i: "ğŸŒ¸"}, {t: "Ø´Ø§ÙŠ", i: "ğŸ«–"}, {t: "Ø³ÙƒØ±", i: "ğŸ¬"}, {t: "Ù…Ø§Ø¡ ØµØ­Ø©", i: "ğŸ’§"}, {t: "ØªÙ…Ø±", i: "ğŸŒ´"}
                    ]},
                    { cat: "Ø¹Ø¯Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ±", items: [
                        {t: "Ø¯Ø§ÙÙˆØ± ØµØºÙŠØ±", i: "ğŸ”¥"}, {t: "Ø°Ø±Ø§ÙŠØ©", i: "ğŸ§±"}, {t: "Ø¨ÙŠØ²", i: "ğŸ§¤"}, {t: "Ù„Ù‚Ù…Ø©", i: "ğŸ¥£"}, {t: "Ø¥Ø¨Ø±ÙŠÙ‚ Ø´Ø§Ù‡ÙŠ", i: "ğŸ«–"}, {t: "Ø£ÙƒÙŠØ§Ø³ Ù†ÙØ§ÙŠØ§Øª", i: "ğŸ—‘ï¸"}
                    ]},
                    { cat: "Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…", items: [
                        {t: "Ø¯Ù„Ø© Ù‚Ù‡ÙˆØ©", i: "ğŸº"}, {t: "Ø²Ù…Ø²Ù…ÙŠØ© Ù‚Ù‡ÙˆØ©", i: "ğŸ§Š"}, {t: "Ø²Ù…Ø²Ù…ÙŠØ© Ø´Ø§Ù‡ÙŠ", i: "ğŸ§Š"}, {t: "ÙÙ†Ø§Ø¬ÙŠÙ„ ÙˆØ¨ÙŠØ§Ù„Ø§Øª", i: "ğŸ¥›"}
                    ]},
                    { cat: "Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ´Ø¨Ù‘Ø© Ø§Ù„Ø¶Ùˆ", items: [
                        {t: "Ù…Ù†Ù‚Ø¯", i: "ğŸ”¥"}, {t: "Ù…Ù„Ù‚Ø§Ø·", i: "ğŸ¥¢"}, {t: "ÙØ±Ø´Ø©", i: "ğŸ›‹ï¸"}, {t: "ÙƒØ±Ø§Ø³ÙŠ", i: "ğŸª‘"}, {t: "Ù…Ø³Ø§Ù†Ø¯", i: "ğŸ›‹ï¸"}, {t: "Ø­Ø·Ø¨", i: "ğŸªµ"}
                    ]}
                ],
                ready_drinks: [
                    { cat: "Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª", items: [
                        {t: "Ø²Ù…Ø²Ù…ÙŠØ© Ù‚Ù‡ÙˆØ© (Ù…Ù„ÙŠØ§Ù†Ø©)", i: "â˜•"}, {t: "Ø²Ù…Ø²Ù…ÙŠØ© Ø´Ø§ÙŠ (Ù…Ù„ÙŠØ§Ù†Ø©)", i: "ğŸ«–"}, {t: "Ù…Ø§Ø¡ Ø¨Ø§Ø±Ø¯", i: "ğŸ’§"}
                    ]},
                    { cat: "Ø³Ù†Ø§ÙƒØ³", items: [
                        {t: "ØªÙ…Ø±", i: "ğŸŒ´"}, {t: "Ù…ÙƒØ³Ø±Ø§Øª", i: "ğŸ¥œ"}, {t: "ÙØ·Ø§Ø¦Ø±", i: "ğŸ¥"}, {t: "Ø´ÙŠØ¨Ø³Ø§Øª", i: "ğŸ¥”"}
                    ]},
                    { cat: "Ø£ØºØ±Ø§Ø¶", items: [
                        {t: "ÙÙ†Ø§Ø¬ÙŠÙ„ ÙˆÙƒØ§Ø³Ø§Øª", i: "ğŸ¥›"}, {t: "Ù…Ù†Ø§Ø¯ÙŠÙ„", i: "ğŸ§»"}, {t: "Ø£ÙƒÙŠØ§Ø³ Ù†ÙØ§ÙŠØ§Øª", i: "ğŸ—‘ï¸"}
                    ]},
                    { cat: "Ø§Ù„Ø¬Ù„Ø³Ø©", items: [ {t: "ÙØ±Ø´Ø© Ø®ÙÙŠÙØ©", i: "ğŸ›‹ï¸"}, {t: "ÙƒØ±Ø§Ø³ÙŠ", i: "ğŸª‘"} ]}
                ]
            },
            sea: {
                cooking: [
                    { cat: "Ø¹Ø´Ø§Ø¡", items: [{t: "Ø³Ù…Ùƒ/Ù…Ø´Ø§ÙˆÙŠ", i: "ğŸŸ"}, {t: "Ø®Ø¨Ø²", i: "ğŸ¥–"}, {t: "Ø¨Ù‡Ø§Ø±Ø§Øª", i: "ğŸ§‚"}, {t: "Ø³Ù„Ø·Ø§Øª", i: "ğŸ¥—"}] },
                    { cat: "Ø´ÙˆÙŠ", items: [{t: "Ù…Ù†Ù‚Ù„ Ø´ÙˆÙŠ", i: "ğŸ”¥"}, {t: "ÙØ­Ù…", i: "ğŸŒ‘"}, {t: "Ù…Ù„Ù‚Ø§Ø·", i: "ğŸ¥¢"}, {t: "Ø£Ø³ÙŠØ§Ø®/Ø´Ø¨Ùƒ", i: "ğŸ¢"}, {t: "Ù‡ÙˆØ§ÙŠØ©", i: "ğŸŒ¬ï¸"}, {t: "Ø£ÙƒÙŠØ§Ø³ Ù†ÙØ§ÙŠØ§Øª", i: "ğŸ—‘ï¸"}] },
                    { cat: "Ø§Ù„Ù‚Ù‡ÙˆØ©", items: [{t: "Ø¯Ù„Ø©", i: "ğŸº"}, {t: "Ù„Ù‚Ù…Ø©", i: "ğŸ¥£"}, {t: "Ø¨ÙŠØ²", i: "ğŸ§¤"}, {t: "Ù‚Ù‡ÙˆØ© ÙˆÙ‡ÙŠÙ„", i: "â˜•"}, {t: "ØªØ±Ø§Ù…Ø³", i: "ğŸ§Š"}] },
                    { cat: "Ø¬Ù„Ø³Ø©", items: [{t: "ÙƒØ±Ø§Ø³ÙŠ", i: "ğŸª‘"}, {t: "Ø·Ø§ÙˆÙ„Ø©", i: "ğŸªµ"}, {t: "ÙØ±Ø´Ø©", i: "ğŸ›‹ï¸"}] }
                ],
                prep_drinks: [
                    { cat: "Ø¹Ø²Ø¨Ø© Ø§Ù„Ù‚Ù‡ÙˆØ©", items: [{t: "Ø¯Ø§ÙÙˆØ±", i: "ğŸ”¥"}, {t: "Ø°Ø±Ø§ÙŠØ©", i: "ğŸ§±"}, {t: "Ø¨ÙŠØ²", i: "ğŸ§¤"}, {t: "Ù„Ù‚Ù…Ø©", i: "ğŸ¥£"}, {t: "Ø¯Ù„Ø©", i: "ğŸº"}, {t: "Ø¥Ø¨Ø±ÙŠÙ‚ Ø´Ø§Ù‡ÙŠ", i: "ğŸ«–"}, {t: "Ø²Ù…Ø²Ù…ÙŠØ©", i: "ğŸ§Š"}, {t: "Ø£ÙƒÙŠØ§Ø³ Ù†ÙØ§ÙŠØ§Øª", i: "ğŸ—‘ï¸"}] },
                    { cat: "Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª", items: [{t: "Ù‚Ù‡ÙˆØ© Ù…Ø·Ø­ÙˆÙ†Ø©", i: "â˜•"}, {t: "Ù‡ÙŠÙ„", i: "ğŸŒ¿"}, {t: "Ø´Ø§ÙŠ ÙˆØ³ÙƒØ±", i: "ğŸ¬"}, {t: "Ù…Ø§Ø¡", i: "ğŸ’§"}] },
                    { cat: "Ø¬Ù„Ø³Ø©", items: [{t: "ÙƒØ±Ø§Ø³ÙŠ", i: "ğŸª‘"}, {t: "Ø·Ø§ÙˆÙ„Ø© ØµØºÙŠØ±Ø©", i: "ğŸªµ"}] }
                ],
                ready_drinks: [
                    { cat: "Ù…Ø´Ø±ÙˆØ¨Ø§Øª", items: [{t: "ØªØ±Ø§Ù…Ø³ Ø¬Ø§Ù‡Ø²Ø©", i: "ğŸ§Š"}, {t: "Ø¹ØµÙŠØ±Ø§Øª Ø¨Ø§Ø±Ø¯Ø©", i: "ğŸ¥¤"}, {t: "Ø«Ù„Ø¬", i: "ğŸ§Š"}] },
                    { cat: "Ø£ØºØ±Ø§Ø¶", items: [{t: "Ø£ÙƒÙŠØ§Ø³ Ù†ÙØ§ÙŠØ§Øª", i: "ğŸ—‘ï¸"}, {t: "Ù…Ù†Ø§Ø¯ÙŠÙ„", i: "ğŸ§»"}] },
                    { cat: "Ø¬Ù„Ø³Ø©", items: [{t: "ÙƒØ±Ø§Ø³ÙŠ Ø´Ø§Ø·Ø¦", i: "ğŸ–ï¸"}, {t: "Ù…Ø¸Ù„Ø©", i: "â›±ï¸"}] }
                ]
            }
        };
        TEMPLATES.chalet = TEMPLATES.land;
        if(!TEMPLATES.sea.ready_drinks) TEMPLATES.sea.ready_drinks = TEMPLATES.land.ready_drinks;

        // --- NAVIGATION & INIT ---
        window.onload = function() { renderSavedLists(); populateIconGrid(); };

        function nextScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            historyStack.push(screenId);
            updateHeader();
        }
        function goBack() {
            if (historyStack.length > 1) {
                historyStack.pop();
                let prevScreen = historyStack[historyStack.length - 1];
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(prevScreen).classList.add('active');
                updateHeader();
            }
        }
        function goToHome() {
            historyStack = ['home-screen'];
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('home-screen').classList.add('active');
            updateHeader();
            renderSavedLists();
        }
        function updateHeader() { document.querySelector('.back-btn').classList.toggle('hidden', historyStack.length <= 1); }

        // --- WIZARD ACTIONS ---
        function selectType(type) { currentSettings.type = type; nextScreen('style-screen'); }
        function selectStyle(style) { currentSettings.style = style; nextScreen('count-screen'); }

        // --- LIST GENERATION ---
        function generateNewList() {
            currentSettings.count = document.getElementById('people-count').value;
            let template = TEMPLATES[currentSettings.type]?.[currentSettings.style] || TEMPLATES.land.cooking;
            
            // Map items to Object Structure {text, icon, assignee}
            activeList = template.map(section => {
                return {
                    cat: section.cat,
                    items: section.items.map(itemObj => {
                        return {
                            text: itemObj.t.replace("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ", currentSettings.count),
                            icon: itemObj.i,
                            assignee: ""
                        };
                    })
                };
            });
            isEditing = false; renderList(); nextScreen('list-screen');
        }

        // --- LIST RENDERING ---
        function renderList() {
            const container = document.getElementById('list-container');
            container.innerHTML = "";
            const editBtn = document.getElementById('edit-btn');
            
            if(isEditing) {
                editBtn.classList.add('active-edit');
                editBtn.innerHTML = "âœ… ØªÙ…";
            } else {
                editBtn.classList.remove('active-edit');
                editBtn.innerHTML = "âœï¸ ØªØ¹Ø¯ÙŠÙ„";
            }

            activeList.forEach((section, secIdx) => {
                let html = `<div class="list-section"><div class="section-title">${section.cat}</div>`;
                section.items.forEach((item, itemIdx) => {
                    html += `<div class="list-item">
                                <div class="item-content">`;
                    
                    if(isEditing) {
                        // EDIT MODE: Icon Button + Text Input
                        html += `<span class="item-icon editable" onclick="openIconModal(${secIdx}, ${itemIdx})">${item.icon}</span>
                                 <input type="text" class="item-input-edit" value="${item.text}" oninput="updateItemText(${secIdx}, ${itemIdx}, this.value)">`;
                    } else {
                        // VIEW MODE: Icon + Text
                        html += `<span class="item-icon">${item.icon}</span>
                                 <span class="item-text">${item.text}</span>`;
                    }
                    
                    html += `</div>`;

                    // Assignee Field
                    html += `<input type="text" class="assignee-input" placeholder="Ù…ÙŠÙ†ØŸ" 
                             value="${item.assignee}" oninput="updateAssignee(${secIdx}, ${itemIdx}, this.value)">`;

                    // Actions
                    if(isEditing) {
                        html += `<span class="delete-btn" onclick="deleteItem(${secIdx}, ${itemIdx})">âœ•</span>`;
                    } else {
                        html += `<input type="checkbox" style="width:20px; height:20px;">`;
                    }
                    html += `</div>`;
                });

                if(isEditing) {
                    html += `<div class="add-row">
                                <input type="text" placeholder="ØºØ±Ø¶ Ø¬Ø¯ÙŠØ¯..." class="add-input" id="new-item-${secIdx}">
                                <button class="add-btn-small" onclick="addItem(${secIdx})">ï¼‹</button>
                             </div>`;
                }
                html += `</div>`;
                container.innerHTML += html;
            });
        }

        // --- DATA UPDATES ---
        function updateAssignee(secIdx, itemIdx, value) { activeList[secIdx].items[itemIdx].assignee = value; }
        function updateItemText(secIdx, itemIdx, value) { activeList[secIdx].items[itemIdx].text = value; }
        function toggleEditMode() { isEditing = !isEditing; renderList(); }
        function deleteItem(secIdx, itemIdx) { activeList[secIdx].items.splice(itemIdx, 1); renderList(); }
        function addItem(secIdx) {
            const input = document.getElementById(`new-item-${secIdx}`);
            const val = input.value.trim();
            if(val) { activeList[secIdx].items.push({ text: val, icon: "ğŸ”¹", assignee: "" }); renderList(); }
        }

        // --- ICON MODAL LOGIC ---
        function populateIconGrid() {
            const grid = document.getElementById('icon-grid');
            grid.innerHTML = "";
            ICONS_LIST.forEach(icon => {
                grid.innerHTML += `<div class="icon-option" onclick="selectIcon('${icon}')">${icon}</div>`;
            });
        }
        function openIconModal(secIdx, itemIdx) {
            editingItemIndices = { sec: secIdx, item: itemIdx };
            document.getElementById('icon-modal').style.display = 'flex';
        }
        function closeIconModal(e) {
            if(e.target.id === 'icon-modal') document.getElementById('icon-modal').style.display = 'none';
        }
        function selectIcon(icon) {
            if (editingItemIndices.sec !== null) {
                activeList[editingItemIndices.sec].items[editingItemIndices.item].icon = icon;
                renderList();
            }
            document.getElementById('icon-modal').style.display = 'none';
        }

        // --- COPY LOGIC ---
        function showCopyModal() { document.getElementById('copy-modal').style.display = 'flex'; }
        function closeCopyModal(e) { if(e.target.id === 'copy-modal') document.getElementById('copy-modal').style.display = 'none'; }

        function copyToClipboard(mode) {
            let text = `ğŸ•ï¸ *Ù‚Ø§Ø¦Ù…Ø© ÙƒØ´ØªØ©: ${currentSettings.count} Ø£Ø´Ø®Ø§Øµ*\n\n`;

            if (mode === 'category') {
                // COPY BY CATEGORY
                activeList.forEach(section => {
                    if(section.items.length > 0) {
                        text += `*${section.cat}*\n`;
                        section.items.forEach(item => {
                            text += `- ${item.icon} ${item.text}`;
                            if(item.assignee) text += ` (ğŸ‘¤ ${item.assignee})`;
                            text += `\n`;
                        });
                        text += `\n`;
                    }
                });
            } else if (mode === 'person') {
                // COPY BY PERSON
                let peopleMap = {};
                let unassigned = [];

                activeList.forEach(section => {
                    section.items.forEach(item => {
                        let name = item.assignee.trim();
                        if(name) {
                            if(!peopleMap[name]) peopleMap[name] = [];
                            peopleMap[name].push(`${item.icon} ${item.text}`);
                        } else {
                            unassigned.push(`${item.icon} ${item.text}`);
                        }
                    });
                });

                for (let person in peopleMap) {
                    text += `ğŸ‘¤ *${person}*\n`;
                    peopleMap[person].forEach(i => text += `- ${i}\n`);
                    text += `\n`;
                }

                if(unassigned.length > 0) {
                    text += `â“ *ØºÙŠØ± Ù…Ø­Ø¯Ø¯*\n`;
                    unassigned.forEach(i => text += `- ${i}\n`);
                }
            }

            text += `_ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ² Ø¹Ø¨Ø± ØªØ·Ø¨ÙŠÙ‚ ÙƒØ´ØªØ©_`;
            navigator.clipboard.writeText(text).then(() => {
                document.getElementById('copy-modal').style.display = 'none';
                alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® Ù„Ù„ÙˆØ§ØªØ³! âœ…");
            });
        }

        // --- SAVING LOGIC ---
        function saveCurrentList() {
            let name = prompt("ÙˆØ´ Ø­Ø§Ø¨ ØªØ³Ù…ÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŸ", "ÙƒØ´ØªØ© Ø§Ù„Ø¬Ù…Ø¹Ø©");
            if(name) {
                let saved = JSON.parse(localStorage.getItem('keshta_saved') || "[]");
                saved.push({
                    id: Date.now(), name: name, date: new Date().toLocaleDateString('ar-SA'),
                    list: activeList, count: currentSettings.count
                });
                localStorage.setItem('keshta_saved', JSON.stringify(saved));
                alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! âœ…");
                goToHome();
            }
        }
        function renderSavedLists() {
            const container = document.getElementById('saved-list-container');
            let saved = JSON.parse(localStorage.getItem('keshta_saved') || "[]");
            if(saved.length === 0) { container.innerHTML = `<div class="empty-state">Ù…Ø§ ÙÙŠÙ‡ ÙƒØ´Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</div>`; return; }
            container.innerHTML = "";
            saved.reverse().forEach((list, index) => {
                let realIndex = saved.length - 1 - index; 
                let html = `<div class="saved-item">
                                <div onclick="loadSavedList(${realIndex})" style="flex:1; cursor:pointer;">
                                    <div class="saved-info"><h4>${list.name}</h4><span>ğŸ“… ${list.date} â€¢ ğŸ‘¥ ${list.count}</span></div>
                                </div>
                                <button class="delete-saved-btn" onclick="deleteSavedList(${realIndex})">ğŸ—‘ï¸</button>
                            </div>`;
                container.innerHTML += html;
            });
        }
        function loadSavedList(index) {
            let saved = JSON.parse(localStorage.getItem('keshta_saved'));
            // Backwards compatibility fix
            activeList = saved[index].list.map(section => ({
                cat: section.cat,
                items: section.items.map(i => ({
                    text: i.text || i,
                    icon: i.icon || "ğŸ”¹", 
                    assignee: i.assignee || ""
                }))
            }));
            currentSettings.count = saved[index].count;
            isEditing = false; renderList(); nextScreen('list-screen');
        }
        function deleteSavedList(index) {
            if(confirm("ØªØ­Ø°Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŸ")) {
                let saved = JSON.parse(localStorage.getItem('keshta_saved'));
                saved.splice(index, 1);
                localStorage.setItem('keshta_saved', JSON.stringify(saved));
                renderSavedLists();
            }
        }
    </script>
</body>
</html>